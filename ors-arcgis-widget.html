  <!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>石川県地域医療・防災マップv0.2.4</title>

  <!-- ArcGIS Maps SDK for JavaScript -->
  <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.30/esri/themes/light/main.css"
  />
  <script src="https://js.arcgis.com/4.30/"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #info {
      padding: 6px 10px;
      font-size: 12px;
      border-bottom: 1px solid #ccc;
      background: #191970;
      color: #ffffff;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }
    #info-left {
      flex: 1 1 auto;
      min-width: 220px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    #stats {
      width: 100%;
      margin-top: 4px;
      font-size: 12px;
    }
    .value {
      font-weight: bold;
    }
    #viewDiv {
      flex: 1;
      width: 100%;
    }
    .mode-button {
      padding: 2px 8px;
      border: 1px solid #888;
      border-radius: 4px;
      background: #ffffff;
      cursor: pointer;
      font-size: 12px;
    }
    .mode-button.active {
      background: #005ea5;
      color: #ffffff;
      border-color: #005ea5;
    }
    .small-button {
      padding: 2px 8px;
      border: 1px solid #888;
      border-radius: 4px;
      background: #ffffff;
      cursor: pointer;
      font-size: 12px;
    }

    .header-link {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: inherit;  /* 文字はそのまま白色 */
    }
    .header-link:active {
      opacity: 0.7;
    }

    /* 免責事項モーダル */
    #disclaimer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #disclaimer-modal {
      background: #ffffff;
      max-width: 600px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      border-radius: 8px;
      padding: 16px 18px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    #disclaimer-modal h2 {
      margin-top: 0;
      font-size: 16px;
    }
    #disclaimer-modal p {
      margin: 6px 0;
      line-height: 1.6;
    }
    #disclaimer-modal .meta {
      margin-top: 8px;
      font-size: 12px;
      color: #555;
    }
    #disclaimer-button {
      margin-top: 12px;
      display: inline-block;
      padding: 6px 14px;
      border-radius: 4px;
      border: none;
      background: #005ea5;
      color: #ffffff;
      cursor: pointer;
      font-size: 14px;
    }

    .header-title {
      font-size: 18pt;
      font-weight: 600;
    }
    .header-sub {
      font-size: 11px;
      opacity: 0.9;
      margin-top: 2px;
    }
    .header-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }

    /* 標高プロファイルパネル */
    #elevation-panel {
      padding: 4px 10px 6px;
      border-bottom: 1px solid #ccc;
      background: #fafafa;
    }
    #elevation-title {
      font-size: 12px;
      margin-bottom: 2px;
      color: #333;
    }
    #elevationChart {
      width: 100%;
      height: 80px;
    }
    .elevation-stats {
      font-size: 11px;
      color: #555;
      margin-top: 2px;
    }

    @media (max-width: 600px) {
      #info {
        font-size: 11px;
        padding: 4px 6px;
      }

      .header-sub {
        display: none;
      }

      #elevationChart {
        height: 40px;
      }

      #elevation-panel {
        padding: 2px 6px;
      }

      .elevation-stats {
        font-size: 10px;
        margin-top: 0px;
      }
    
      #disclaimer-modal {
        padding: 12px 14px;
      }

      .esri-expand__content,
      .esri-expand__panel {
        max-height: 35vh !important;
        overflow-y: auto !important;
      }
    }
  </style>
</head>

<body>
  <!-- 免責事項オーバーレイ -->
  <div id="disclaimer-overlay">
    <div id="disclaimer-modal">
      <h2>免責事項 / Disclaimer</h2>
      <p>
        本アプリは、一般向けおよび教育用として、地図情報・避難所情報・ルート案内・危険箇所等の防災関連情報を提供するものです。
        掲載内容は、公開データおよび作成時点の情報に基づいており、
        その正確性・完全性・最新性を保証するものではありません。
      </p>
      <p>
        災害時には道路状況、通行可否、避難所の開設状況、周辺環境などが急速に変化します。
        本アプリの情報はあくまで参考としてご利用いただき、
        実際の避難行動・安全確保は、必ず自治体等の公的情報および現地の状況を優先して判断してください。
      </p>
      <p>
        本アプリの利用に関連して生じたいかなる損害・トラブルについても、
        石川県立看護大学災害実践看護学講座 木田研究室（以下「本研究室」）は、一切の責任を負いかねます。
      </p>
      <div class="meta">
        <div>運営者：石川県立看護大学災害実践看護学講座 木田研究室</div>
        <div>バージョン：v0.2.4</div>
        <div>●データ出典：</div>
        <div>国土交通省国土数値情報ダウンロードサイト（https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A31a-2024.html、</div>
        <div>https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A33-2024.html、https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-mesh250r6.html）</div>
        <div>厚生労働省医療情報ネットのオープンデータ，介護サービス情報の公表システムデータのオープンデータ</div>
        <div>国土地理院避難所等データダウンロードサイト（https://hinanmap.gsi.go.jp/hinanjocp/hinanbasho/koukaidate.html?utm_source=chatgpt.com</div>）
      </div>
      <button id="disclaimer-button">同意して利用する</button>
    </div>
  </div>

  <div id="app">
    <div id="info">
      <div id="info-left">
        <div class="header-row">
          <a href="ors-arcgis-widget.html" class="header-link">
            <img src="icon.png" alt="ロゴ" class="header-icon" />
            <span class="header-title">石川県地域医療・防災マップ（v0.2.4）</span>
          </a>
        </div>

        <div class="header-sub">
          地図上をクリックして出発地・到着地を指定します。<br />
          ・1回目のクリック：出発地（緑） ／ 2回目：到着地（赤） → 自動でルート計算 ／
          3回目：ルートリセット
        </div>
      </div>
      <div id="controls">
        <span>移動手段:</span>
        <button id="btn-car" class="mode-button active">車</button>
        <button id="btn-walk" class="mode-button">徒歩</button>
        <button id="btn-current" class="small-button">現在地を出発地に</button>
        <button id="btn-route-mode" class="small-button">ルート検索：ON</button>
        <div id="stats">
          距離: <span id="distance" class="value">–</span> km ／
          時間: <span id="duration" class="value">–</span> 分 ／
          上り: <span id="ascent" class="value">–</span> m ／
          下り: <span id="descent" class="value">–</span> m
        </div>
      </div>
    </div>

    <!-- 標高プロファイル -->
    <div id="elevation-panel">
      <div id="elevation-title">ルートの高低差</div>
      <canvas id="elevationChart"></canvas>
      <div id="elevation-stats" class="elevation-stats">
        min: – m ／ max: – m
      </div>
    </div>

    <div id="viewDiv"></div>
  </div>

<script>
  // ★ Cloudflare Worker の ORS プロキシURL
  const ORS_PROXY_URL = "https://ors-route-proxy.r-kida-tky.workers.dev/";
  // Web マップ ID
  const WEBMAP_ID = "a941c0ddd83d4d2994c388364ffe3558";

  // ORS の profile（移動モード）
  let currentProfile = "driving-car"; // driving-car / foot-walking

  // 免責事項モーダルを閉じる
  document.getElementById("disclaimer-button").addEventListener("click", function () {
    const overlay = document.getElementById("disclaimer-overlay");
    overlay.style.display = "none";
  });

  // ArcGIS JS API
  require([
    "esri/WebMap",
    "esri/views/MapView",
    "esri/layers/GraphicsLayer",
    "esri/Graphic",
    "esri/geometry/support/webMercatorUtils",
    "esri/widgets/Sketch",
    "esri/widgets/Print",
    "esri/widgets/Legend",
    "esri/widgets/LayerList",
    "esri/widgets/Expand",
    "esri/widgets/Search",
    "esri/widgets/DistanceMeasurement2D"
  ], function (
    WebMap,
    MapView,
    GraphicsLayer,
    Graphic,
    webMercatorUtils,
    Sketch,
    Print,
    Legend,
    LayerList,
    Expand,
    Search,
    DistanceMeasurement2D
  ) {

    const webmap = new WebMap({
      portalItem: { id: WEBMAP_ID }
    });

    const view = new MapView({
      container: "viewDiv",
      map: webmap
    });

    // ルート・スケッチレイヤ
    const routeLayer = new GraphicsLayer();
    const sketchLayer = new GraphicsLayer();
    webmap.addMany([routeLayer, sketchLayer]);

    let startGraphic = null;
    let endGraphic = null;
    let routeGraphic = null;

    // 距離計測ウィジェット（DistanceMeasurement2D 用）
    let distanceMeasurement = null;
    let routeModeOn = true;

    const distanceEl = document.getElementById("distance");
    const durationEl = document.getElementById("duration");
    const ascentEl   = document.getElementById("ascent");
    const descentEl  = document.getElementById("descent");

    const btnCar     = document.getElementById("btn-car");
    const btnWalk    = document.getElementById("btn-walk");
    const btnCurrent = document.getElementById("btn-current");
    const btnRouteMode = document.getElementById("btn-route-mode");

    function setMode(mode) {
      currentProfile = mode;
      if (mode === "driving-car") {
        btnCar.classList.add("active");
        btnWalk.classList.remove("active");
      } else {
        btnWalk.classList.add("active");
        btnCar.classList.remove("active");
      }
      if (startGraphic && endGraphic) {
        requestRoute();
      }
    }

    btnCar.addEventListener("click", function () { setMode("driving-car"); });
    btnWalk.addEventListener("click", function () { setMode("foot-walking"); });


    function updateRouteModeButton() {
      if (routeModeOn) {
        btnRouteMode.textContent = "ルート検索：ON";
        btnRouteMode.style.backgroundColor = "#005ea5";
        btnRouteMode.style.color = "#ffffff";
      } else {
        btnRouteMode.textContent = "ルート検索: OFF";
        btnRouteMode.style.backgroundColor = "#ffffff";
        btnRouteMode.style.color = "#000000";
      }
    }

    btnRouteMode.addEventListener("click", function () {
      routeModeOn = !routeModeOn;
      // OFF にしたタイミングでルート表示をクリアしておくと親切
      if (!routeModeOn) {
        resetRoute();
      }
      updateRouteModeButton();
    });

    // 初期状態の表示を反映
    updateRouteModeButton();

    
    // 標高グラフ消去
    function clearElevationChart() {
      const canvas = document.getElementById("elevationChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const w = canvas.width  = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, w, h);

      const elevStatsEl = document.getElementById("elevation-stats");
      if (elevStatsEl) {
        elevStatsEl.textContent = "min: – m ／ max: – m";
      }
    }

    function resetRoute() {
      routeLayer.removeMany(
        [startGraphic, endGraphic, routeGraphic].filter(function (g) { return g; })
      );
      startGraphic = null;
      endGraphic = null;
      routeGraphic = null;

      distanceEl.textContent = "–";
      durationEl.textContent = "–";
      ascentEl.textContent   = "–";
      descentEl.textContent  = "–";

      clearElevationChart();
    }

    // 標高プロファイル描画（シンプル版）
    function updateElevationChart(coords) {
      const canvas = document.getElementById("elevationChart");
      if (!canvas) return;

      if (!coords || coords.length === 0) {
        clearElevationChart();
        return;
      }

      const ctx = canvas.getContext("2d");
      const w = canvas.width  = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, w, h);

      const distances = [0];
      const elevations = [];

      const first = coords[0];
      const z0 = first.length > 2 ? first[2] : 0;
      elevations.push(z0);

      let totalDist = 0;
      for (let i = 1; i < coords.length; i++) {
        const prev = coords[i - 1];
        const curr = coords[i];

        const lon1 = prev[0], lat1 = prev[1];
        const lon2 = curr[0], lat2 = curr[1];

        const xy1 = webMercatorUtils.lngLatToXY(lon1, lat1);
        const xy2 = webMercatorUtils.lngLatToXY(lon2, lat2);
        const dx = xy2[0] - xy1[0];
        const dy = xy2[1] - xy1[1];
        const segDist = Math.sqrt(dx * dx + dy * dy);

        totalDist += segDist;
        distances.push(totalDist);

        const z = curr.length > 2 ? curr[2] : z0;
        elevations.push(z);
      }

      const distKm = distances.map(function (d) { return d / 1000; });
      const minElev = Math.min.apply(null, elevations);
      const maxElev = Math.max.apply(null, elevations);
      const pad = (maxElev - minElev) * 0.1 || 10;
      const yMin = minElev - pad;
      const yMax = maxElev + pad;

      // ★ min / max 表示
      const elevStatsEl = document.getElementById("elevation-stats");
      if (elevStatsEl) {
        const minDisp = Math.round(minElev * 10) / 10;
        const maxDisp = Math.round(maxElev * 10) / 10;
        elevStatsEl.textContent =
          "min: " + minDisp + " m ／ max: " + maxDisp + " m";
      }

      // 軸
      ctx.strokeStyle = "#666";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(30, 5);
      ctx.lineTo(30, h - 15);
      ctx.lineTo(w - 5, h - 15);
      ctx.stroke();

      // 折れ線
      ctx.strokeStyle = "rgba(0,90,160,0.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let j = 0; j < elevations.length; j++) {
        const t = distKm[j] / distKm[distKm.length - 1] || 0;
        const x = 30 + t * (w - 35);
        const ratio = (elevations[j] - yMin) / (yMax - yMin || 1);
        const y = (h - 15) - ratio * (h - 25);
        if (j === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
    }

    async function requestRoute() {
      if (!startGraphic || !endGraphic) return;

      const startGeo = webMercatorUtils.webMercatorToGeographic(
        startGraphic.geometry
      );
      const endGeo = webMercatorUtils.webMercatorToGeographic(
        endGraphic.geometry
      );

      // Cloudflare Worker プロキシに投げる
      const body = {
        profile: currentProfile,   // "driving-car" or "foot-walking"
        coordinates: [
          [startGeo.x, startGeo.y],
          [endGeo.x, endGeo.y]
        ]
      };

      const res = await fetch(ORS_PROXY_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json; charset=utf-8"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        alert("ルート計算に失敗しました (HTTP " + res.status + ")");
        return;
      }

      const json = await res.json();
      const feature = json.features[0];
      const props = feature.properties || {};
      const summary = props.summary || (props.segments && props.segments[0]) || {};

      if (routeGraphic) {
        routeLayer.remove(routeGraphic);
        routeGraphic = null;
      }

      const coords = feature.geometry.coordinates;
      updateElevationChart(coords);

      const paths = coords.map(function (c) {
        const lon = c[0];
        const lat = c[1];
        const xy = webMercatorUtils.lngLatToXY(lon, lat);
        return [xy[0], xy[1]];
      });

      const polyline = {
        type: "polyline",
        paths: [paths],
        spatialReference: view.spatialReference
      };

      routeGraphic = new Graphic({
        geometry: polyline,
        symbol: {
          type: "simple-line",
          color: [0, 0, 255, 0.8],
          width: 3
        }
      });

      routeLayer.add(routeGraphic);
      view.goTo(routeGraphic.geometry.extent.expand(1.3));

      const distanceKm =
        summary.distance != null ? (summary.distance / 1000).toFixed(1) : "–";
      const durationMin =
        summary.duration != null ? (summary.duration / 60).toFixed(1) : "–";
      const ascent =
        summary.ascent != null ? Math.round(summary.ascent) : "–";
      const descent =
        summary.descent != null ? Math.round(summary.descent) : "–";

      distanceEl.textContent = distanceKm;
      durationEl.textContent = durationMin;
      ascentEl.textContent   = ascent;
      descentEl.textContent  = descent;
    }

        view.on("click", function (event) {

      // ★ ルート検索モードが OFF のときは、ルート処理は一切しない
      //    （マップ本来のクリック挙動＝ポップアップ表示などだけが動く）
      if (!routeModeOn) {
        return;
      }

      // 距離計測ツールが「計測中」のときはルート処理をスキップ
      if (distanceMeasurement &&
          distanceMeasurement.viewModel &&
          distanceMeasurement.viewModel.state === "measuring") {
        return;
      }

      const point = event.mapPoint;

      if (!startGraphic) {
        // 1回目クリック：リセットして出発地
        resetRoute();
        startGraphic = new Graphic({
          geometry: point,
          symbol: {
            type: "simple-marker",
            color: "green",
            size: 10,
            outline: { color: "white", width: 1 }
          }
        });
        routeLayer.add(startGraphic);

      } else if (!endGraphic) {
        // 2回目クリック：到着地 → ルート計算
        endGraphic = new Graphic({
          geometry: point,
          symbol: {
            type: "simple-marker",
            color: "red",
            size: 10,
            outline: { color: "white", width: 1 }
          }
        });
        routeLayer.add(endGraphic);
        requestRoute();

      } else {
        // 3回目クリック：リセットだけ（新しい出発地は置かない）
        resetRoute();
        // ここで return するのがポイント
        return;
      }
    });

    // 現在地ボタン
    btnCurrent.addEventListener("click", function () {
      if (!navigator.geolocation) {
        alert("このブラウザは現在地取得に対応していません。");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          const xy = webMercatorUtils.lngLatToXY(lon, lat);
          const point = {
            type: "point",
            x: xy[0],
            y: xy[1],
            spatialReference: view.spatialReference
          };

          resetRoute();
          startGraphic = new Graphic({
            geometry: point,
            symbol: {
              type: "simple-marker",
              color: "green",
              size: 10,
              outline: { color: "white", width: 1 }
            }
          });
          routeLayer.add(startGraphic);

          view.goTo({ target: point, zoom: 15 });
        },
        function (err) {
          console.error(err);
          alert("現在地を取得できませんでした。位置情報の許可設定をご確認ください。");
        }
      );
    });

    // Search ヴィジェット
    const searchWidget = new Search({
      view: view,
      includeDefaultSources: true,
      popupEnabled: true,
      locationEnabled: true
    });
    const searchExpand = new Expand({
      view: view,
      content: searchWidget,
      expanded: false,
      expandTooltip: "場所を検索",
      icon: "esri-icon-search",
      group: "top-right-tools",
      autoCollapse: true
    });
    view.ui.add(searchExpand, "top-right");

    // Sketch ウィジェット（Expand で折りたたみ）
    const sketch = new Sketch({
      view: view,
      layer: sketchLayer,
      availableCreateTools: ["point", "polyline", "polygon", "rectangle", "circle", "text"],
      creationMode: "update",
      defaultCreateOptions: {
        mode: "freehand"
      }
    });
    // ★ 連続描画モード

    sketch.on("create", function (event) {
      if (event.state === "complete") {
        const tool = event.tool;
        if (tool) {
          sketch.create(tool);   // 同じツールを連続開始
        }
      }
    });
    
    const sketchExpand = new Expand({
      view: view,
      content: sketch,
      expanded: false,
      expandTooltip: "描画ツール",
      icon: "esri-icon-edit",
      group: "top-right-tools",
      autoCollapse: true
    });
    view.ui.add(sketchExpand, "top-right");

    // 距離計測 & Print ウィジェットは view が準備できてから追加
    view.when(function () {
    // 距離計測 & Print ウィジェットは view が準備できてから追加
    view.when(function () {

      // ★ polylineツールのアイコンを鉛筆マークに差し替え
      //   SketchウィジェットがDOMに描画されるのを少し待ってから実行
      setTimeout(function () {
        // data-type="polyline" のボタンの中にある、polylineアイコン要素を探す
        const polyIcon = document.querySelector(
          '.esri-sketch__button[data-type="polyline"] .esri-icon-polyline'
        );

      if (polyIcon) {
        polyIcon.classList.remove("esri-icon-polyline");
        polyIcon.classList.add("esri-icon-edit");
      }
    }, 500);
  
      // 距離計測ウィジェット
      distanceMeasurement = new DistanceMeasurement2D({
        view: view
      });

      const measurementExpand = new Expand({
        view: view,
        content: distanceMeasurement,
        expanded: false,
        expandTooltip: "距離を計測",
        icon: "esri-icon-measure-line",
        group: "top-right-tools",
        autoCollapse: true
      });
      view.ui.add(measurementExpand, "top-right");

      // パネルを閉じたら計測結果を自動クリア
      measurementExpand.watch("expanded", function (expanded) {
        if (!expanded && distanceMeasurement) {
          // DistanceMeasurement2D の結果を消す
          if (distanceMeasurement.clear) {
            distanceMeasurement.clear();
          } else if (distanceMeasurement.viewModel &&
                     distanceMeasurement.viewModel.clear) {
            distanceMeasurement.viewModel.clear();
          }
        }
      });


      // Print ウィジェット
      const print = new Print({
        view: view,
        templateOptions: {
          title: "わたしの地域医療・防災マップ"
        }
      });
      const printExpand = new Expand({
        view: view,
        content: print,
        expanded: false,
        expandTooltip: "印刷",
        group: "top-right-tools",
        autoCollapse: true
      });
      view.ui.add(printExpand, {
        position: "top-left",
        index: 2
      });
    });

    // 凡例 & レイヤーリスト（Expand）
    const legend = new Legend({ view: view });
    const legendExpand = new Expand({
      view: view,
      content: legend,
      expanded: false,
      expandTooltip: "凡例",
      icon: "esri-icon-layer-list",
      group: "left-tools",
      autoCollapse: true
    });

    const layerList = new LayerList({ view: view });
    const layerListExpand = new Expand({
      view: view,
      content: layerList,
      expanded: false,
      expandTooltip: "レイヤー",
      icon: "esri-icon-table",
      group: "left-tools",
      autoCollapse: true
    });

    view.ui.add(legendExpand, "bottom-left");
    view.ui.add(layerListExpand, "top-left");
  });
</script>

</body>
</html>































