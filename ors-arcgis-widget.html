<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>防災マップ（ルート検索＋描画＋印刷）</title>

  <!-- ArcGIS Maps SDK for JavaScript -->
  <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.30/esri/themes/light/main.css"
  />
  <script src="https://js.arcgis.com/4.30/"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #info {
      padding: 6px 10px;
      font-size: 12px;
      border-bottom: 1px solid #ccc;
      background: #f7f7f7;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }
    #info-left {
      flex: 1 1 auto;
      min-width: 220px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    #stats {
      width: 100%;
      margin-top: 4px;
      font-size: 12px;
    }
    .value {
      font-weight: bold;
    }
    #viewDiv {
      flex: 1;
      width: 100%;
    }
    .mode-button {
      padding: 2px 8px;
      border: 1px solid #888;
      border-radius: 4px;
      background: #ffffff;
      cursor: pointer;
      font-size: 12px;
    }
    .mode-button.active {
      background: #005ea5;
      color: #ffffff;
      border-color: #005ea5;
    }
    .small-button {
      padding: 2px 8px;
      border: 1px solid #888;
      border-radius: 4px;
      background: #ffffff;
      cursor: pointer;
      font-size: 12px;
    }

    /* 免責事項モーダル */
    #disclaimer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #disclaimer-modal {
      background: #ffffff;
      max-width: 600px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      border-radius: 8px;
      padding: 16px 18px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    #disclaimer-modal h2 {
      margin-top: 0;
      font-size: 16px;
    }
    #disclaimer-modal p {
      margin: 6px 0;
      line-height: 1.6;
    }
    #disclaimer-modal .meta {
      margin-top: 8px;
      font-size: 12px;
      color: #555;
    }
    #disclaimer-button {
      margin-top: 12px;
      display: inline-block;
      padding: 6px 14px;
      border-radius: 4px;
      border: none;
      background: #005ea5;
      color: #ffffff;
      cursor: pointer;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      #info {
        font-size: 11px;
      }
      #disclaimer-modal {
        padding: 12px 14px;
      }
    }
  </style>
</head>

<body>
  <!-- 免責事項オーバーレイ -->
  <div id="disclaimer-overlay">
    <div id="disclaimer-modal">
      <h2>免責事項 / Disclaimer</h2>
      <p>
        本アプリは、一般向けおよび教育用として、地図情報・避難所情報・ルート案内・危険箇所等の防災関連情報を提供するものです。
        掲載内容は、公開データおよび作成時点の情報に基づいており、
        その正確性・完全性・最新性を保証するものではありません。
      </p>
      <p>
        災害時には道路状況、通行可否、避難所の開設状況、周辺環境などが急速に変化します。
        本アプリの情報はあくまで参考としてご利用いただき、
        実際の避難行動・安全確保は、必ず自治体等の公的情報および現地の状況を優先して判断してください。
      </p>
      <p>
        本アプリの利用に関連して生じたいかなる損害・トラブルについても、
        石川県立看護大学災害実践看護学講座 木田研究室（以下「本研究室」）は、一切の責任を負いかねます。
      </p>
      <div class="meta">
        <div>運営者：石川県立看護大学災害実践看護学講座 木田研究室</div>
        <div>バージョン：v0.2.2</div>
      </div>
      <button id="disclaimer-button">同意して利用する</button>
    </div>
  </div>

  <div id="app">
    <div id="info">
      <div id="info-left">
        <b>防災マップ：ルート検索 ＋ 描画 ＋ PDF出力</b><br />
        地図上をクリックして出発地・到着地を指定します。<br />
        ・1回目のクリック：出発地（緑） ／ 2回目：到着地（赤） → 自動でルート計算<br />
        ・3回目以降：リセットして新しい出発地を指定
      </div>
      <div id="controls">
        <span>移動手段:</span>
        <button id="btn-car" class="mode-button active">車</button>
        <button id="btn-walk" class="mode-button">徒歩</button>
        <button id="btn-current" class="small-button">現在地を出発地に</button>
        <div id="stats">
          距離: <span id="distance" class="value">–</span> km ／
          時間: <span id="duration" class="value">–</span> 分 ／
          上り: <span id="ascent" class="value">–</span> m ／
          下り: <span id="descent" class="value">–</span> m
        </div>
      </div>
    </div>
    <div id="viewDiv"></div>
  </div>

  <script>
    // ★★★ 必ず自分の ORS APIキー に書き換えてください ★★★
    const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjZiZTRmMmM5MDdkMjQ5NWU4MzAyZWZkNmZhYWYzMWMyIiwiaCI6Im11cm11cjY0In0=";

    // あなたの Web マップ ID（例のURL：webmap=a941c0ddd83d4d2994c388364ffe3558）
    const WEBMAP_ID   = "a941c0ddd83d4d2994c388364ffe3558";

    // ORS の profile（移動モード）
    let currentProfile = "driving-car"; // driving-car / foot-walking

    // 免責事項モーダルを閉じる
    document.getElementById("disclaimer-button").addEventListener("click", function () {
      const overlay = document.getElementById("disclaimer-overlay");
      overlay.style.display = "none";
    });

    // ArcGIS JS API
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/geometry/support/webMercatorUtils",
      "esri/widgets/Sketch",
      "esri/widgets/Print",
      "esri/widgets/Legend",
      "esri/widgets/LayerList",
      "esri/widgets/Expand"
    ], function (
      WebMap,
      MapView,
      GraphicsLayer,
      Graphic,
      webMercatorUtils,
      Sketch,
      Print,
      Legend,
      LayerList,
      Expand
    ) {
      const webmap = new WebMap({
        portalItem: {
          id: WEBMAP_ID
        }
      });

      const view = new MapView({
        container: "viewDiv",
        map: webmap
      });

      // ルート・マーカー用レイヤ
      const routeLayer = new GraphicsLayer();
      // スケッチ用レイヤ
      const sketchLayer = new GraphicsLayer();

      webmap.addMany([routeLayer, sketchLayer]);

      let startGraphic = null;
      let endGraphic = null;
      let routeGraphic = null;

      const distanceEl = document.getElementById("distance");
      const durationEl = document.getElementById("duration");
      const ascentEl   = document.getElementById("ascent");
      const descentEl  = document.getElementById("descent");

      const btnCar     = document.getElementById("btn-car");
      const btnWalk    = document.getElementById("btn-walk");
      const btnCurrent = document.getElementById("btn-current");

      function setMode(mode) {
        currentProfile = mode;
        if (mode === "driving-car") {
          btnCar.classList.add("active");
          btnWalk.classList.remove("active");
        } else {
          btnWalk.classList.add("active");
          btnCar.classList.remove("active");
        }
        if (startGraphic && endGraphic) {
          requestRoute();
        }
      }

      btnCar.addEventListener("click", function () {
        setMode("driving-car");
      });

      btnWalk.addEventListener("click", function () {
        setMode("foot-walking");
      });

      function resetRoute() {
        routeLayer.removeMany(
          [startGraphic, endGraphic, routeGraphic].filter(g => g)
        );
        startGraphic = null;
        endGraphic = null;
        routeGraphic = null;

        distanceEl.textContent = "–";
        durationEl.textContent = "–";
        ascentEl.textContent   = "–";
        descentEl.textContent  = "–";
      }

      async function requestRoute() {
        if (!startGraphic || !endGraphic) return;

        const startGeo = webMercatorUtils.webMercatorToGeographic(
          startGraphic.geometry
        );
        const endGeo = webMercatorUtils.webMercatorToGeographic(
          endGraphic.geometry
        );

        const url =
          "https://api.openrouteservice.org/v2/directions/" +
          encodeURIComponent(currentProfile) +
          "/geojson";

        const body = {
          coordinates: [
            [startGeo.x, startGeo.y],
            [endGeo.x, endGeo.y]
          ],
          elevation: true
        };

        const res = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: ORS_API_KEY,
            "Content-Type": "application/json; charset=utf-8"
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          alert("ルート計算に失敗しました (HTTP " + res.status + ")");
          return;
        }

        const json = await res.json();
        const feature = json.features[0];
        const props = feature.properties || {};
        const summary = props.summary || (props.segments && props.segments[0]) || {};

        if (routeGraphic) {
          routeLayer.remove(routeGraphic);
          routeGraphic = null;
        }

        const coords = feature.geometry.coordinates;
        const paths = coords.map(function (c) {
          const lon = c[0];
          const lat = c[1];
          const xy = webMercatorUtils.lngLatToXY(lon, lat);
          return [xy[0], xy[1]];
        });

        const polyline = {
          type: "polyline",
          paths: [paths],
          spatialReference: view.spatialReference
        };

        routeGraphic = new Graphic({
          geometry: polyline,
          symbol: {
            type: "simple-line",
            color: [0, 0, 255, 0.8],
            width: 3
          }
        });

        routeLayer.add(routeGraphic);
        view.goTo(routeGraphic.geometry.extent.expand(1.3));

        const distanceKm =
          summary.distance != null ? (summary.distance / 1000).toFixed(1) : "–";
        const durationMin =
          summary.duration != null ? (summary.duration / 60).toFixed(1) : "–";
        const ascent =
          summary.ascent != null ? Math.round(summary.ascent) : "–";
        const descent =
          summary.descent != null ? Math.round(summary.descent) : "–";

        distanceEl.textContent = distanceKm;
        durationEl.textContent = durationMin;
        ascentEl.textContent   = ascent;
        descentEl.textContent  = descent;
      }

      // 地図クリック：出発地／到着地
      view.on("click", function (event) {
        const point = event.mapPoint;

        if (!startGraphic) {
          resetRoute();
          startGraphic = new Graphic({
            geometry: point,
            symbol: {
              type: "simple-marker",
              color: "green",
              size: 10,
              outline: {
                color: "white",
                width: 1
              }
            }
          });
          routeLayer.add(startGraphic);
        } else if (!endGraphic) {
          endGraphic = new Graphic({
            geometry: point,
            symbol: {
              type: "simple-marker",
              color: "red",
              size: 10,
              outline: {
                color: "white",
                width: 1
              }
            }
          });
          routeLayer.add(endGraphic);
          requestRoute();
        } else {
          resetRoute();
          startGraphic = new Graphic({
            geometry: point,
            symbol: {
              type: "simple-marker",
              color: "green",
              size: 10,
              outline: {
                color: "white",
                width: 1
              }
            }
          });
          routeLayer.add(startGraphic);
        }
      });

      // 現在地ボタン
      btnCurrent.addEventListener("click", function () {
        if (!navigator.geolocation) {
          alert("このブラウザは現在地取得に対応していません。");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          function (pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            const xy = webMercatorUtils.lngLatToXY(lon, lat);
            const point = {
              type: "point",
              x: xy[0],
              y: xy[1],
              spatialReference: view.spatialReference
            };

            resetRoute();
            startGraphic = new Graphic({
              geometry: point,
              symbol: {
                type: "simple-marker",
                color: "green",
                size: 10,
                outline: {
                  color: "white",
                  width: 1
                }
              }
            });
            routeLayer.add(startGraphic);

            view.goTo({ target: point, zoom: 15 });
          },
          function (err) {
            console.error(err);
            alert("現在地を取得できませんでした。位置情報の許可設定をご確認ください。");
          }
        );
      });

      // Sketch ウィジェット
      const sketch = new Sketch({
        view: view,
        layer: sketchLayer,
        availableCreateTools: ["point", "polyline", "polygon", "rectangle", "circle", "text"],
        creationMode: "update"
      });
      view.ui.add(sketch, "top-right");

      // Print ウィジェット
      const print = new Print({
        view: view
      });
      view.when(() => {
        view.ui.add(print, {
          position: "top-left",
          index: 1
        });
      });

      // 凡例 & レイヤーリスト（Expand で畳めるように）
      const legend = new Legend({
        view: view
      });
      const legendExpand = new Expand({
        view: view,
        content: legend,
        expanded: false,
        expandTooltip: "凡例"
      });

      const layerList = new LayerList({
        view: view
      });
      const layerListExpand = new Expand({
        view: view,
        content: layerList,
        expanded: false,
        expandTooltip: "レイヤー"
      });

      view.ui.add(legendExpand, "bottom-left");
      view.ui.add(layerListExpand, "top-left");
    });
  </script>
</body>
</html>
